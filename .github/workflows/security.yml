name: Security CI (Bandit)

on: [push, pull_request]  # workflow запускается при пуше или открытии/обновлении Pull Request

jobs:
  bandit:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3 # проверка репозитория

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: 3.11 # установка Python

      - name: Install dependencies
        run: |
          pip install bandit # установка Bandit

      - name: Run Bandit and fail on high
        run: |
          bandit -r . -lll -iii -f json -o bandit.json || true # запуск Bandit рекурсивно по всей директории, JSON в bandit.json
          
          python -c "import json,sys; d=json.load(open('bandit.json')); sys.exit(1 if any(i.get('issue_severity')=='HIGH' for i in d.get('results',[])) else 0)"
          # проверка JSON: если есть хотя бы одна критическая уязвимость - падение
